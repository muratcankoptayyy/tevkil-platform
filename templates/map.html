{% extends "base.html" %}

{% block title %}Harita - Ulusal Tevkil Ağı Projesi{% endblock %}

{% block content %}
<div class="flex flex-col h-screen">
    <!-- Header -->
    <div class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 p-4">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
                <span class="material-symbols-outlined text-primary text-2xl md:text-4xl">map</span>
                <div>
                    <h1 class="text-lg md:text-2xl font-bold text-gray-900 dark:text-white">İlan Haritası</h1>
                    <p class="text-sm text-gray-600 dark:text-gray-400">{{ posts|length }} ilan haritada gösteriliyor</p>
                </div>
            </div>
            
            <!-- View Toggle -->
            <div class="flex gap-2">
                <a href="{{ url_for('list_posts') }}" class="px-4 py-2 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition flex items-center gap-2">
                    <span class="material-symbols-outlined">view_list</span>
                    Liste
                </a>
                <button class="px-4 py-2 rounded-lg bg-primary text-white flex items-center gap-2 w-full sm:w-auto">
                    <span class="material-symbols-outlined">map</span>
                    Harita
                </button>
            </div>
        </div>
    </div>

    <!-- Map Container -->
    <div class="flex-1 relative">
        <div id="map" class="w-full h-full"></div>
        
        <!-- Loading Indicator -->
        <div id="mapLoading" class="absolute inset-0 bg-white/80 dark:bg-gray-900/80 flex items-center justify-center z-10">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-3"></div>
                <p class="text-gray-600 dark:text-gray-400">Harita yükleniyor...</p>
            </div>
        </div>
    </div>
</div>

<!-- Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_key }}&callback=initMap&libraries=places&language=tr&region=TR" async defer></script>

<script>
let map;
let markers = [];
let infoWindow;

// İlan verileri
const posts = {{ posts_json | safe }};

function initMap() {
    console.log('🗺️ Harita başlatılıyor...', posts.length, 'ilan');
    
    // Hide loading
    document.getElementById('mapLoading').style.display = 'none';
    
    // Türkiye merkezi
    const center = { lat: 39.9334, lng: 32.8597 };
    
    // Map options
    map = new google.maps.Map(document.getElementById('map'), {
        zoom: 6,
        center: center,
        mapTypeControl: true,
        streetViewControl: false,
        fullscreenControl: true,
        zoomControl: true,
        styles: [
            {
                featureType: 'poi',
                elementType: 'labels',
                stylers: [{ visibility: 'off' }]
            }
        ]
    });
    
    // Info window
    infoWindow = new google.maps.InfoWindow();
    
    // Bounds for auto-fit
    const bounds = new google.maps.LatLngBounds();
    
    // Add markers
    posts.forEach(post => {
        if (!post.latitude || !post.longitude) {
            console.warn('Koordinat yok:', post.id, post.title);
            return;
        }
        
        const position = { lat: post.latitude, lng: post.longitude };
        
        // Marker color based on urgency
        let markerColor = '#3B82F6'; // blue (normal)
        if (post.urgency_level === 'urgent') {
            markerColor = '#F59E0B'; // orange
        } else if (post.urgency_level === 'very_urgent') {
            markerColor = '#EF4444'; // red
        }
        
        // Custom marker icon
        const markerIcon = {
            path: google.maps.SymbolPath.CIRCLE,
            fillColor: markerColor,
            fillOpacity: 0.9,
            strokeColor: '#ffffff',
            strokeWeight: 2,
            scale: 10
        };
        
        const marker = new google.maps.Marker({
            position: position,
            map: map,
            title: post.title,
            icon: markerIcon,
            animation: google.maps.Animation.DROP
        });
        
        // Info window content
        const contentString = `
            <div style="max-width: 300px; font-family: 'Manrope', sans-serif;">
                <div style="background: linear-gradient(135deg, #3B82F6, #8B5CF6); padding: 12px; margin: -12px -12px 12px -12px; border-radius: 8px 8px 0 0;">
                    <h3 style="color: white; margin: 0; font-size: 16px; font-weight: 600;">${post.title}</h3>
                </div>
                
                <div style="padding: 0 4px;">
                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 8px; color: #6B7280;">
                        <span class="material-symbols-outlined" style="font-size: 18px;">location_on</span>
                        <span style="font-size: 13px;">${post.city} - ${post.courthouse}</span>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 8px; color: #6B7280;">
                        <span class="material-symbols-outlined" style="font-size: 18px;">category</span>
                        <span style="font-size: 13px;">${post.category}</span>
                    </div>
                    
                    ${post.court_date ? `
                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 12px; color: #6B7280;">
                        <span class="material-symbols-outlined" style="font-size: 18px;">event</span>
                        <span style="font-size: 13px;">${post.court_date}</span>
                    </div>
                    ` : ''}
                    
                    ${post.price_display ? `
                    <div style="background: #F3F4F6; padding: 8px; border-radius: 6px; margin-bottom: 12px;">
                        <div style="display: flex; align-items: center; gap: 6px; color: #059669;">
                            <span class="material-symbols-outlined" style="font-size: 18px;">payments</span>
                            <span style="font-size: 14px; font-weight: 600;">${post.price_display}</span>
                        </div>
                    </div>
                    ` : ''}
                    
                    <a href="/posts/${post.id}" 
                       style="display: inline-block; width: 100%; text-align: center; background: #3B82F6; color: white; padding: 10px; border-radius: 6px; text-decoration: none; font-weight: 600; font-size: 14px; transition: all 0.3s;"
                       onmouseover="this.style.background='#2563EB'"
                       onmouseout="this.style.background='#3B82F6'">
                        İlanı Görüntüle
                    </a>
                </div>
            </div>
        `;
        
        marker.addListener('click', () => {
            infoWindow.setContent(contentString);
            infoWindow.open(map, marker);
        });
        
        markers.push(marker);
        bounds.extend(position);
    });
    
    // Fit map to markers
    if (markers.length > 0) {
        map.fitBounds(bounds);
        
        // Don't zoom in too much for single markers
        google.maps.event.addListenerOnce(map, 'bounds_changed', function() {
            if (markers.length === 1) {
                this.setZoom(Math.min(14, this.getZoom()));
            }
        });
    }
    
    console.log('✅ Harita yüklendi!', markers.length, 'marker eklendi');
}

// Error handler
window.gm_authFailure = function() {
    document.getElementById('mapLoading').innerHTML = `
        <div class="text-center p-4 md:p-8">
            <span class="material-symbols-outlined text-red-500 text-6xl mb-4">error</span>
            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">Harita Yüklenemedi</h3>
            <p class="text-gray-600 dark:text-gray-400">Google Maps API anahtarı gerekli</p>
        </div>
    `;
};
</script>
{% endblock %}
