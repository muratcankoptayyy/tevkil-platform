{% extends "base.html" %}

{% block title %}İlanlar - Ulusal Tevkil Ağı Projesi{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
<script src="https://cdn.tailwindcss.com"></script>
<script>
    tailwind.config = {
        darkMode: 'class',
        theme: {
            extend: {
                colors: {
                    'primary': '#2563eb',
                    'primary-dark': '#1e40af',
                    'secondary': '#64748b',
                    'background': '#f8fafc',
                    'background-light': '#ffffff',
                    'background-dark': '#0f172a',
                    'text': '#1e293b',
                    'text-light': '#64748b',
                    'border': '#e2e8f0',
                }
            }
        }
    }
</script>
<style>
    .material-symbols-outlined {
        font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }
    .fill-icon {
        font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto py-8 px-4">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="mb-6 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-text dark:text-white">İlanlar</h1>
            <a href="{{ url_for('create_post') }}" class="bg-primary hover:bg-primary-dark text-white px-6 py-2 rounded-lg transition-colors flex items-center gap-2">
                <span class="material-symbols-outlined">add</span>
                Yeni İlan
            </a>
        </div>

        <!-- Search and Filters Card -->
        <div class="bg-background-light dark:bg-slate-800 rounded-xl shadow-sm mb-6">
            <div class="flex flex-col sm:flex-row gap-3 p-3">
                <!-- Search Input -->
                <div class="flex-1 relative">
                    <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-text-light">search</span>
                    <input 
                        type="text" 
                        id="searchInput"
                        placeholder="Anahtar kelime ile ara..." 
                        class="w-full pl-10 pr-4 py-2.5 border border-border dark:border-slate-700 rounded-lg bg-background dark:bg-slate-900 text-text dark:text-white focus:outline-none focus:ring-2 focus:ring-primary/50"
                    />
                </div>
                
                <!-- City Filter -->
                <div class="relative">
                    <select 
                        id="cityFilter"
                        class="appearance-none px-4 py-2.5 pr-10 border border-border dark:border-slate-700 rounded-lg bg-background dark:bg-slate-900 text-text dark:text-white hover:border-primary transition-colors focus:outline-none focus:ring-2 focus:ring-primary/50 cursor-pointer"
                    >
                        <option value="">Tüm Şehirler</option>
                        {% for city in cities %}
                        <option value="{{ city }}">{{ city }}</option>
                        {% endfor %}
                    </select>
                    <span class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-text-light pointer-events-none">expand_more</span>
                </div>
                
                <!-- Category Filter -->
                <div class="relative">
                    <select 
                        id="categoryFilter"
                        class="appearance-none px-4 py-2.5 pr-10 border border-border dark:border-slate-700 rounded-lg bg-background dark:bg-slate-900 text-text dark:text-white hover:border-primary transition-colors focus:outline-none focus:ring-2 focus:ring-primary/50 cursor-pointer"
                    >
                        <option value="">Tüm Görevler</option>
                        <option value="hukuk_durusma">Hukuk Duruşması</option>
                        <option value="hukuk_durusma_tanikli">Hukuk Duruşması (Tanıklı)</option>
                        <option value="ceza_durusma">Ceza Duruşması</option>
                        <option value="icra_dairesi">İcra Dairesi</option>
                        <option value="haciz_muhafazasiz">Haciz (Muhafazasız)</option>
                        <option value="haciz_muhafazali">Haciz (Muhafazalı)</option>
                        <option value="savcilik_bilgi">Savcılık - Bilgi Alma</option>
                        <option value="savcilik_dosya">Savcılık - Dosya</option>
                        <option value="savcilik_diger">Savcılık - Diğer</option>
                        <option value="kalem_islemleri">Kalem İşlemleri</option>
                        <option value="adliye_sorgu">Adliye Sorgu</option>
                        <option value="kesif">Keşif</option>
                        <option value="dosya_inceleme">Dosya İnceleme</option>
                        <option value="adliye_ifade">Adliye İfade</option>
                        <option value="idare_vergi_durusma">İdare/Vergi Duruşması</option>
                        <option value="bam_durusma">BAM Duruşma</option>
                        <option value="yargitay_durusma">Yargıtay Duruşma</option>
                        <option value="diger">Diğer</option>
                    </select>
                    <span class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-text-light pointer-events-none">expand_more</span>
                </div>
                
                <!-- Urgency Filter -->
                <div class="relative">
                    <select 
                        id="urgencyFilter"
                        class="appearance-none px-4 py-2.5 pr-10 border border-border dark:border-slate-700 rounded-lg bg-background dark:bg-slate-900 text-text dark:text-white hover:border-primary transition-colors focus:outline-none focus:ring-2 focus:ring-primary/50 cursor-pointer"
                    >
                        <option value="">Tüm Aciliyet</option>
                        <option value="normal">Normal</option>
                        <option value="urgent">Acil</option>
                        <option value="very_urgent">Çok Acil</option>
                    </select>
                    <span class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-text-light pointer-events-none">expand_more</span>
                </div>
            </div>
        </div>

        <!-- Posts List -->
        {% if posts %}
        <div class="space-y-4" id="postsContainer">
            {% for post in posts %}
            <div class="bg-background-light dark:bg-slate-800 rounded-xl p-6 border border-border dark:border-slate-700 hover:shadow-lg hover:border-primary transition-all duration-200 post-card"
                 data-title="{{ post.title|lower }}"
                 data-description="{{ post.description|lower }}"
                 data-city="{{ post.city|lower if post.city else '' }}"
                 data-category="{{ post.category }}"
                 data-urgency="{{ post.urgency_level }}">
                
                <div class="flex items-start gap-4">
                    <!-- Post Owner Avatar -->
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center text-primary font-bold text-lg">
                            {{ post.user.full_name[0] if post.user and post.user.full_name else 'A' }}
                        </div>
                    </div>
                    
                    <!-- Post Content -->
                    <div class="flex-1 min-w-0">
                        <!-- Post Owner Info -->
                        <div class="flex items-center gap-2 mb-2">
                            <span class="font-semibold text-text dark:text-white">
                                {{ post.user.full_name if post.user else 'Bilinmeyen' }}
                            </span>
                            <span class="text-text-light dark:text-slate-400">·</span>
                            <span class="text-sm text-text-light dark:text-slate-400">
                                {{ post.user.bar_association if post.user and post.user.bar_association else 'Baro belirtilmemiş' }}
                            </span>
                        </div>
                        
                        <!-- Post Title -->
                        <h3 class="text-xl font-bold text-text dark:text-white mb-2">
                            <a href="{{ url_for('post_detail', post_id=post.id) }}" class="hover:text-primary transition-colors">
                                {{ post.title }}
                            </a>
                        </h3>
                        
                        <!-- Category & Urgency Badges -->
                        <div class="flex flex-wrap items-center gap-2 mb-3">
                            <span class="px-3 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300 text-sm rounded-full font-medium">
                                {% if post.category == 'hukuk_durusma' %}Hukuk Duruşması
                                {% elif post.category == 'hukuk_durusma_tanikli' %}Hukuk Duruşması (Tanıklı)
                                {% elif post.category == 'ceza_durusma' %}Ceza Duruşması
                                {% elif post.category == 'icra_dairesi' %}İcra Dairesi
                                {% elif post.category == 'haciz_muhafazasiz' %}Haciz (Muhafazasız)
                                {% elif post.category == 'haciz_muhafazali' %}Haciz (Muhafazalı)
                                {% elif post.category == 'savcilik_bilgi' %}Savcılık - Bilgi Alma
                                {% elif post.category == 'savcilik_dosya' %}Savcılık - Dosya
                                {% elif post.category == 'savcilik_diger' %}Savcılık - Diğer
                                {% elif post.category == 'kalem_islemleri' %}Kalem İşlemleri
                                {% elif post.category == 'adliye_sorgu' %}Adliye Sorgu
                                {% elif post.category == 'kesif' %}Keşif
                                {% elif post.category == 'dosya_inceleme' %}Dosya İnceleme
                                {% elif post.category == 'adliye_ifade' %}Adliye İfade
                                {% elif post.category == 'idare_vergi_durusma' %}İdare/Vergi Duruşması
                                {% elif post.category == 'bam_durusma' %}BAM Duruşma
                                {% elif post.category == 'yargitay_durusma' %}Yargıtay Duruşma
                                {% else %}{{ post.category|title }}
                                {% endif %}
                            </span>
                            
                            {% if post.urgency_level == 'very_urgent' %}
                            <span class="px-3 py-1 bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300 text-sm rounded-full font-medium flex items-center gap-1">
                                <span class="material-symbols-outlined text-base">error</span>
                                Çok Acil
                            </span>
                            {% elif post.urgency_level == 'urgent' %}
                            <span class="px-3 py-1 bg-orange-100 dark:bg-orange-900/30 text-orange-800 dark:text-orange-300 text-sm rounded-full font-medium flex items-center gap-1">
                                <span class="material-symbols-outlined text-base">schedule</span>
                                Acil
                            </span>
                            {% endif %}
                        </div>
                        
                        <!-- Description Preview -->
                        {% if post.description %}
                        <p class="text-text dark:text-white mb-4" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                            {{ post.description[:200] }}{% if post.description|length > 200 %}...{% endif %}
                        </p>
                        {% endif %}
                        
                        <!-- Post Details Grid -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                            <!-- Location -->
                            <div class="flex items-center gap-2">
                                <span class="material-symbols-outlined text-text-light dark:text-slate-400 text-xl">location_on</span>
                                <div class="min-w-0">
                                    <div class="text-xs text-text-light dark:text-slate-400">Yer</div>
                                    <div class="text-sm font-medium text-text dark:text-white truncate">
                                        {{ post.city or 'Belirtilmemiş' }}
                                    </div>
                                    {% if post.courthouse %}
                                    <div class="text-xs text-text-light dark:text-slate-400 truncate">{{ post.courthouse }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Date & Time -->
                            <div class="flex items-center gap-2">
                                <span class="material-symbols-outlined text-text-light dark:text-slate-400 text-xl">calendar_today</span>
                                <div class="min-w-0">
                                    <div class="text-xs text-text-light dark:text-slate-400">Tarih & Saat</div>
                                    {% if post.court_date %}
                                    <div class="text-sm font-medium text-text dark:text-white">
                                        {{ post.court_date.strftime('%d.%m.%Y') }}
                                    </div>
                                    <div class="text-xs text-text-light dark:text-slate-400">
                                        {{ post.court_date.strftime('%H:%M') }}
                                    </div>
                                    {% else %}
                                    <div class="text-sm text-text-light dark:text-slate-400">Belirtilmemiş</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Price -->
                            <div class="flex items-center gap-2">
                                <span class="material-symbols-outlined text-text-light dark:text-slate-400 text-xl">payments</span>
                                <div class="min-w-0">
                                    <div class="text-xs text-text-light dark:text-slate-400">Ücret</div>
                                    {% if post.price_min and post.price_max %}
                                    <div class="text-sm font-medium text-text dark:text-white">
                                        {{ post.price_min|int }}-{{ post.price_max|int }} TL
                                    </div>
                                    {% elif post.price_min %}
                                    <div class="text-sm font-medium text-text dark:text-white">
                                        {{ post.price_min|int }} TL
                                    </div>
                                    {% else %}
                                    <div class="text-sm text-text-light dark:text-slate-400">Belirtilmemiş</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Application Count -->
                            <div class="flex items-center gap-2">
                                <span class="material-symbols-outlined text-text-light dark:text-slate-400 text-xl">group</span>
                                <div class="min-w-0">
                                    <div class="text-xs text-text-light dark:text-slate-400">Başvuru</div>
                                    <div class="text-sm font-medium text-text dark:text-white">
                                        {{ post.applications.count() }} kişi
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="flex items-center gap-3 pt-4 border-t border-border dark:border-slate-700">
                            <a href="{{ url_for('post_detail', post_id=post.id) }}" 
                               class="flex-1 bg-primary text-white px-4 py-2.5 rounded-lg font-semibold hover:bg-primary-dark transition-colors flex items-center justify-center gap-2">
                                <span class="material-symbols-outlined text-lg">visibility</span>
                                Detayları Gör
                            </a>
                            
                            {% if current_user.is_authenticated %}
                            <button onclick="toggleFavorite({{ post.id }}, this)" 
                                    class="favorite-btn p-2.5 rounded-lg border border-border dark:border-slate-700 hover:bg-background dark:hover:bg-slate-700 transition-colors" 
                                    data-favorited="{{ 'true' if post.id in current_user_favorites else 'false' }}">
                                <span class="material-symbols-outlined text-xl {% if post.id in current_user_favorites %}text-red-500 fill-icon{% else %}text-text-light{% endif %}">favorite</span>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Total Count -->
        <div class="mt-6 text-center text-text-light dark:text-slate-400">
            Toplam <span class="font-semibold text-text dark:text-white" id="totalCount">{{ posts|length }}</span> ilan görüntüleniyor
        </div>
        
        {% else %}
        <!-- Empty State -->
        <div class="bg-background-light dark:bg-slate-800 rounded-xl p-12 border-2 border-dashed border-border dark:border-slate-700 text-center">
            <span class="material-symbols-outlined text-6xl text-text-light dark:text-slate-600 mb-4 block">inbox</span>
            <h3 class="text-xl font-semibold text-text dark:text-white mb-2">Henüz ilan bulunmuyor</h3>
            <p class="text-text-light dark:text-slate-400 mb-6">İlk ilanı siz oluşturun ve meslektaşlarınızla paylaşın!</p>
            <a href="{{ url_for('create_post') }}" class="bg-primary text-white px-8 py-3 rounded-lg font-semibold hover:bg-primary-dark transition-colors inline-flex items-center gap-2">
                <span class="material-symbols-outlined">add</span>
                Yeni İlan Oluştur
            </a>
        </div>
        {% endif %}
    </div>
</div>

<script>
    // Filter and Search functionality
    const searchInput = document.getElementById('searchInput');
    const cityFilter = document.getElementById('cityFilter');
    const categoryFilter = document.getElementById('categoryFilter');
    const urgencyFilter = document.getElementById('urgencyFilter');
    const postCards = document.querySelectorAll('.post-card');
    const totalCount = document.getElementById('totalCount');

    function filterPosts() {
        const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
        const selectedCity = cityFilter ? cityFilter.value.toLowerCase() : '';
        const selectedCategory = categoryFilter ? categoryFilter.value : '';
        const selectedUrgency = urgencyFilter ? urgencyFilter.value : '';
        
        let visibleCount = 0;

        postCards.forEach(card => {
            const title = card.dataset.title || '';
            const description = card.dataset.description || '';
            const city = card.dataset.city || '';
            const category = card.dataset.category || '';
            const urgency = card.dataset.urgency || '';

            const matchesSearch = !searchTerm || title.includes(searchTerm) || description.includes(searchTerm);
            const matchesCity = !selectedCity || city.includes(selectedCity);
            const matchesCategory = !selectedCategory || category === selectedCategory;
            const matchesUrgency = !selectedUrgency || urgency === selectedUrgency;

            if (matchesSearch && matchesCity && matchesCategory && matchesUrgency) {
                card.style.display = '';
                visibleCount++;
            } else {
                card.style.display = 'none';
            }
        });

        if (totalCount) {
            totalCount.textContent = visibleCount;
        }
    }

    // Add event listeners
    if (searchInput) searchInput.addEventListener('input', filterPosts);
    if (cityFilter) cityFilter.addEventListener('change', filterPosts);
    if (categoryFilter) categoryFilter.addEventListener('change', filterPosts);
    if (urgencyFilter) urgencyFilter.addEventListener('change', filterPosts);

    // Favorite toggle function
    function toggleFavorite(postId, button) {
        fetch(`/favorites/toggle/${postId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const icon = button.querySelector('.material-symbols-outlined');
                if (data.action === 'added') {
                    icon.classList.add('text-red-500', 'fill-icon');
                    icon.classList.remove('text-gray-400');
                    button.dataset.favorited = 'true';
                } else {
                    icon.classList.remove('text-red-500', 'fill-icon');
                    icon.classList.add('text-gray-400');
                    button.dataset.favorited = 'false';
                }
            }
        })
        .catch(error => console.error('Error:', error));
    }
</script>
{% endblock %}
